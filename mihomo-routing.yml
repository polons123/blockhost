mode: rule
mixed-port: 7897
allow-lan: false
log-level: error
ipv6: false
# external-controller: 127.0.0.1:59090
# secret: ''
# external-controller-cors:
#  allow-private-network: true
#  allow-origins:
#  - '*'
unified-delay: true
tcp-concurrent: true
dns:
  default-nameserver:
  - system
  - 77.88.8.8
  - 8.8.8.8
  direct-nameserver-follow-policy: false
  enable: true
  enhanced-mode: redir-host # redir-host  or fake-ip
  nameserver:
  - https://hostingvds-mon.ydns.eu:8443/dns-query
  - https://vdska-fin.ydns.eu/dns-query
  - https://vdska-pl.ydns.eu/dns-query
  prefer-h3: true
  proxy-server-nameserver:
  - https://hosting-mon.ydns.eu:8443/dns-query
  - https://vdska-fin.ydns.eu/dns-query
  - https://vdska-pl.ydns.eu/dns-query
  respect-rules: false
  use-hosts: false
  use-system-hosts: false
profile:
  store-selected: true
  store-fake-ip: true
tun:
  enable: true
  stack: gvisor
  mtu: 9000
  auto-route: true
  strict-route: true
  gso: true
  gso-max-size: 65536
  udp-timeout: 300
  iproute2-table-index: 2022
  iproute2-rule-index: 9000
  endpoint-independent-nat: false
  auto-detect-interface: true
  dns-hijack:
  - any:53
  - tcp://any:53
  device: utun11
  route-exclude-address:
  - 0.0.0.0/8
  - 100.64.0.0/10
  - 127.0.0.0/8
  - 169.254.0.0/16
  - 172.16.0.0/12
  - 192.0.0.0/24
  - 192.0.2.0/24
  - 192.88.99.0/24
  - 192.168.0.0/16
  - 198.51.100.0/24
  - 203.0.113.0/24
  - 224.0.0.0/4
  - 255.255.255.255/32
  - 239.255.255.250/32

#geox-url:
#  geoip: "https://fastly.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geoip.dat"
#  geosite: "https://fastly.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geosite.dat"
#  mmdb: "https://fastly.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geoip.metadb"
#  asn: "https://github.com/xishang0128/geoip/releases/download/latest/GeoLite2-ASN.mmdb"
#geo-auto-update: true
#geo-update-interval: 86400

#  TCP keep alive interval
#  15  для компьютера
#  1800 для телефона, увеличение интервала экономит батарею 
keep-alive-interval: 30
keep-alive-idle: 120
disable-keep-alive: true

sniffer:
  enable: true
  sniff:
    QUIC:
      ports: [443, 8443]
    TLS:
      ports: [443, 8443]
    HTTP:
      ports: [80, 8080-8880]
      override-destination: true
  skip-domain:
    # LAN домены - полностью переносим
    - '+.lan'
    - '+.localdomain'
    - '+.example'
    - '+.invalid'
    - '+.localhost'
    - '+.test'
    - '+.local'
    - '+.home.arpa'
    - '+.direct'
    
    # NTP сервисы - полностью переносим (UDP протокол)
    - 'time.*.com'
    - 'time.*.gov'
    - 'time.*.edu.cn'
    - 'time.*.apple.com'
    - 'time-ios.apple.com'
    - 'time1.*.com'
    - 'time2.*.com'
    - 'time3.*.com'
    - 'time4.*.com'
    - 'time5.*.com'
    - 'time6.*.com'
    - 'time7.*.com'
    - 'ntp.*.com'
    - 'ntp1.*.com'
    - 'ntp2.*.com'
    - 'ntp3.*.com'
    - 'ntp4.*.com'
    - 'ntp5.*.com'
    - 'ntp6.*.com'
    - 'ntp7.*.com'
    - '+.time.edu.cn'
    - '+.ntp.org.cn'
    - '+.pool.ntp.org'
    
    # STUN сервисы - полностью переносим (UDP протокол)
    - 'stun.*.*'
    - 'stun.*.*.*'
    - '+.stun.*.*'
    - '+.stun.*.*.*'
    - '+.stun.*.*.*.*'
    - '+.stun.*.*.*.*.*'
    
    # Push-уведомления и системные проверки
    - "+.push.apple.com"
    - "captive.apple.com"
    - "ocsp.apple.com"
    - "ocsp2.apple.com"
    - "mesu.apple.com"
    - "swscan.apple.com"
    - "swquery.apple.com"
    - "swdownload.apple.com"
    - "swcdn.apple.com"
    - "swdist.apple.com"
    - "configuration.apple.com"
    - "setup.icloud.com"
    - "p*.mail.icloud.com"
    - '+.fcm.googleapis.com'
    - '+.android.googleapis.com'
    - '+.msftconnecttest.com'
    - '+.msftncsi.com'
    - 'captive.apple.com'
    - 'detectportal.firefox.com'
    - '+.connectivitycheck.gstatic.com'
  skip-src-address:
    - "10.0.0.0/8"
    - "172.16.0.0/12"
    - "192.168.0.0/16"
    - "127.0.0.0/8"
  skip-dst-address:
    - "10.0.0.0/8"
    - "172.16.0.0/12"
    - "192.168.0.0/16"
    - "127.0.0.0/8"
    - "224.0.0.0/4"

proxies:
  
  - name: "Socks-local"
    type: socks5
    server: 192.168.1.151
    port: 7897
    udp: true

  - name: "Dom-VM"
    type: vmess
    server: 95.165.6.169
    port: 64845
    uuid: 7040f7de-3e63-4ff1-8a77-37c70b319eb2
    alterId: 0
    #ip-version: ipv6-prefer
    cipher: chacha20-poly1305
    tls: false
    udp: true
    tcp-fast-open: true

  - name: "TimeWeb-VM"
    type: vmess
    server: 217.18.63.172
    port: 63219
    uuid: 74f5992e-3090-4159-8ad5-4778d3b29118
    alterId: 0
    ip-version: ipv6-prefer
    cipher: chacha20-poly1305
    network: ws
    ws-opts:
      path: /Video-data
      headers:
        Host: 217.18.63.172
      v2ray-http-upgrade: true
    tls: false
    udp: true
    tcp-fast-open: true
  - name: TimeWeb-tuic
    type: tuic
    server: timeweb-spb.ddns.net
    port: 443
    uuid: 7aa312e0-e549-4766-8d3d-592420c18077
    password: 76747c5c-c9e8-4883-aec2-1fb8f81c5baa
    ip: 217.18.63.172
    # heartbeat-interval: 10000
    # alpn: [h3]
    disable-sni: true
    reduce-rtt: true
    request-timeout: 8000
    udp-relay-mode: native
    congestion-controller: bbr
    # max-udp-relay-packet-size: 1500
    fast-open: true
    # skip-cert-verify: true
    max-open-streams: 60
    # sni: example.com

  - name: "Selectel-VM"
    type: vmess
    server: 188.68.221.199
    port: 63219
    uuid: 74f5992e-3090-4159-8ad5-4778d3b29118
    alterId: 0
    ip-version: ipv6-prefer
    cipher: chacha20-poly1305
    network: ws
    ws-opts:
      path: /Video-data
      headers:
        Host: 188.68.221.199
      v2ray-http-upgrade: true
    tls: false
    udp: true
    tcp-fast-open: true
  - name: Selectel-tuic
    type: tuic
    server: selectel-spb.ydns.eu
    port: 443
    uuid: 7aa312e0-e549-4766-8d3d-592420c18077
    password: 76747c5c-c9e8-4883-aec2-1fb8f81c5baa
    ip: 188.68.221.199
    # heartbeat-interval: 10000
    # alpn: [h3]
    disable-sni: true
    reduce-rtt: true
    request-timeout: 8000
    udp-relay-mode: native
    congestion-controller: bbr
    # max-udp-relay-packet-size: 1500
    fast-open: true
    # skip-cert-verify: true
    max-open-streams: 60
    # sni: example.com

  - name: Aeza
    type: tuic
    server: aeza-usa.ddns.net
    port: 443
    uuid: 7aa312e0-e549-4766-8d3d-592420c18077
    password: 76747c5c-c9e8-4883-aec2-1fb8f81c5baa
    ip: 77.110.126.157
    # heartbeat-interval: 10000
    # alpn: [h3]
    disable-sni: true
    reduce-rtt: true
    request-timeout: 8000
    udp-relay-mode: native
    congestion-controller: bbr
    # max-udp-relay-packet-size: 1500
    fast-open: true
    # skip-cert-verify: true
    max-open-streams: 60
    # sni: example.com
  
  - name: H2nexus
    type: tuic
    server: h2nexus.ddns.net
    port: 443
    uuid: 7aa312e0-e549-4766-8d3d-592420c18077
    password: 76747c5c-c9e8-4883-aec2-1fb8f81c5baa
    ip: 45.144.52.52
    # heartbeat-interval: 10000
    # alpn: [h3]
    disable-sni: true
    reduce-rtt: true
    request-timeout: 8000
    udp-relay-mode: native
    congestion-controller: bbr
    # max-udp-relay-packet-size: 1500
    fast-open: true
    # skip-cert-verify: true
    max-open-streams: 60
    # sni: example.com

  - name: SaleDedic
    type: tuic
    server: salededic-swe.ddns.net
    port: 443
    uuid: 7aa312e0-e549-4766-8d3d-592420c18077
    password: 76747c5c-c9e8-4883-aec2-1fb8f81c5baa
    ip: 109.122.201.73
    # heartbeat-interval: 10000
    # alpn: [h3]
    disable-sni: true
    reduce-rtt: true
    request-timeout: 8000
    udp-relay-mode: native
    congestion-controller: bbr
    # max-udp-relay-packet-size: 1500
    fast-open: true
    # skip-cert-verify: true
    max-open-streams: 60
    # sni: example.com
  
  - name: Waicore
    type: tuic
    server: waicore-ger.ddns.net
    port: 443
    uuid: 7aa312e0-e549-4766-8d3d-592420c18077
    password: 76747c5c-c9e8-4883-aec2-1fb8f81c5baa
    ip: 193.233.134.245
    # heartbeat-interval: 10000
    # alpn: [h3]
    disable-sni: true
    reduce-rtt: true
    request-timeout: 8000
    udp-relay-mode: native
    congestion-controller: bbr
    # max-udp-relay-packet-size: 1500
    fast-open: true
    # skip-cert-verify: true
    max-open-streams: 60
    # sni: example.com


proxy-groups:
  - name: "PROXY"
    type: select
    proxies:
      - Balancer-tuic
      - Balancer-vm
      - Dom-VM
      - Socks-local
      - TimeWeb-VM
      - TimeWeb-tuic
      - Selectel-VM
      - Selectel-tuic
      - Aeza
      - H2nexus
      - SaleDedic
      - Waicore
      
  - name: "Balancer-tuic"
    type: load-balance
    proxies:
      - TimeWeb-tuic
      - Selectel-tuic
    #url: 'https://www.gstatic.com/generate_204'
    #interval: 300
    lazy: true
    strategy: sticky-sessions
  - name: "Balancer-vm"
    type: load-balance
    proxies:
      - TimeWeb-VM
      - Selectel-VM
    #url: 'https://www.gstatic.com/generate_204'
    #interval: 300
    lazy: true
    strategy: sticky-sessions

rule-providers:
  geosite-google:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/google.mrs"
    path: ./geosite-google.mrs
    interval: 86400  
  geosite-apple:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/apple.mrs"
    path: ./geosite-apple.mrs
    interval: 86400
  geosite-youtube:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/youtube.mrs"
    path: ./geosite-youtube.mrs   
    interval: 86400
  geoip-google:
    type: http
    behavior: ipcidr
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geoip/google.mrs"
    path: ./geoip-google.mrs
    interval: 86400
  geoip-apple:
    type: http
    behavior: ipcidr
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo-lite/geoip/apple.mrs"
    path: ./geoip-apple.mrs
    interval: 86400
  geoip-ru:
    type: http
    behavior: ipcidr
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geoip/ru.mrs"
    path: ./geoip-ru.mrs
    interval: 86400

rules:
  - DST-PORT,25,DIRECT
  - DST-PORT,110,DIRECT
  - DST-PORT,143,DIRECT
  - DST-PORT,465,DIRECT
  - DST-PORT,585,DIRECT
  - DST-PORT,587,DIRECT
  - DST-PORT,993,DIRECT
  - DST-PORT,995,DIRECT
  - DST-PORT,18090,DIRECT
  - DST-PORT,18092,DIRECT
  - DST-PORT,59090,DIRECT
  - DST-PORT,2195,DIRECT #push уведомления
  - DST-PORT,2196,DIRECT
  - DST-PORT,2197,DIRECT
  - DST-PORT,5223,DIRECT
  - DST-PORT,5228,DIRECT
  - DST-PORT,5229,DIRECT
  - DST-PORT,5230,DIRECT # конец push уведомлений
  - IP-CIDR,10.0.0.0/8,DIRECT,no-resolve
  - IP-CIDR,127.0.0.0/8,DIRECT,no-resolve
  - IP-CIDR,172.16.0.0/12,DIRECT,no-resolve
  - IP-CIDR,192.168.0.0/16,DIRECT,no-resolve
  - IP-CIDR,95.165.6.169/32,DIRECT,no-resolve
  - IP-CIDR,::1/128,DIRECT
  # Apple Push Notifications
  - DOMAIN-SUFFIX,push.apple.com,DIRECT
  - DOMAIN,push.apple.com,DIRECT
  - DOMAIN-SUFFIX,api.push.apple.com,DIRECT
  - DOMAIN,gateway.push.apple.com,DIRECT
  - DOMAIN,gateway.sandbox.push.apple.com,DIRECT
  # Google/Firebase Push Notifications
  - DOMAIN-SUFFIX,fcm.googleapis.com,DIRECT
  - DOMAIN,fcm.googleapis.com,DIRECT
  - DOMAIN-SUFFIX,android.googleapis.com,DIRECT
  - DOMAIN,android.googleapis.com,DIRECT
  # WNS
  - DOMAIN-SUFFIX,notify.windows.com,DIRECT
  - DOMAIN,outlook.office365.com,DIRECT
  - DOMAIN,m.hotmail.com,DIRECT
  - DOMAIN,hotmail.com,DIRECT

  - RULE-SET,geosite-google,PROXY
  - RULE-SET,geosite-apple,PROXY
  - RULE-SET,geosite-youtube,PROXY

  - RULE-SET,geoip-google,PROXY
  - RULE-SET,geoip-apple,PROXY
  
  - DOMAIN,kino.pub,PROXY
  - DOMAIN-KEYWORD,habr,PROXY
  - DOMAIN-SUFFIX,themoviedb.org,PROXY
  - DOMAIN-SUFFIX,tmbd.org,PROXY
  - DOMAIN-SUFFIX,themoviedb.org,PROXY
  - DOMAIN-SUFFIX,tmdb-image-prod.b-cdn.net,PROXY
  - DOMAIN-SUFFIX,cdn.cookielaw.org,PROXY
  
  - DOMAIN-SUFFIX,ru,DIRECT
  - DOMAIN-SUFFIX,su,DIRECT
  - DOMAIN-SUFFIX,vokino.tv,DIRECT
  - DOMAIN-SUFFIX,yandex.net,DIRECT
  - DOMAIN,polons.synology.me,DIRECT
  - DOMAIN,evpolondacha.keenetic.link,DIRECT
  - DOMAIN,evpolondom.keenetic.name,DIRECT
  - RULE-SET,geoip-ru,DIRECT
  #- GEOIP,RU,DIRECT
  - MATCH,PROXY
